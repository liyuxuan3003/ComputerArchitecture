\makeatletter\def\input@path{{minimus}{standalone-silicon}}\makeatother

\documentclass{standalone-silicon}

\usepackage{minimus-text}
\usepackage{minimus-math}
\usepackage{minimus-tikz}

\usepackage{RISCVMicroarchitecture}

\begin{document}
\begin{tikzpicture}[font=\ttfamily]

\def\ulen{0.4}

\path (0,0) coordinate (O) ;
\path (0,0) coordinate (xML) ;
\path (3.5,0) coordinate (xCL) ;
\path (0,0) coordinate (yMB) ;
\path (0,-2) coordinate (yCB) ;

% Bit of memory address
\foreach \x in {0,1,...,9}
{
    \path ($(xML|-yMB)+(\x*\ulen,0)$) node[cache bit] (M\x) {} ;  
}

% Bit of cache way 0
\foreach \x in {0,1,...,37}
{
    \foreach \y in {0,1}
    {
        \path ($(xCL|-yCB)+(\x*\ulen,\y*\ulen)$) node[cache bit] (C\y-\x) {} ;  
    } 
}

% Block of memory address
% Tag   M0 ~ M4
% Set   M5 ~ M5
% Block M6 ~ M7
% Byte  M8 ~ M9
\path (O) node[cache block,fit=(M0.south west)(M4.north east)] (MTag) {} ; 
\path (O) node[cache block,fit=(M5.south west)(M5.north east)] (MSet) {} ; 
\path (O) node[cache block,fit=(M6.south west)(M7.north east)] (MBlock) {} ; 
\path (O) node[cache block,fit=(M8.south west)(M9.north east)] (MByte) {} ; 

% Block of cache
% V     Cn-0  ~ Cn-0
% Tag   Cn-1  ~ Cn-5
% Data3 Cn-6  ~ Cn-13
% Data2 Cn-14 ~ Cn-21
% Data1 Cn-22 ~ Cn-29
% Data0 Cn-30 ~ Cn-37
\foreach \y in {0,1}
{
    \path (O) node[cache block,fit=(C\y-0.south west)(C\y-0.north east)] (C\y V) {} ;
    \path (O) node[cache block,fit=(C\y-1.south west)(C\y-5.north east)] (C\y Tag) {} ;
    \path (O) node[cache block,fit=(C\y-6.south west)(C\y-13.north east)] (C\y Data3) {} ;
    \path (O) node[cache block,fit=(C\y-14.south west)(C\y-21.north east)] (C\y Data3) {} ;
    \path (O) node[cache block,fit=(C\y-14.south west)(C\y-21.north east)] (C\y Data2) {} ;
    \path (O) node[cache block,fit=(C\y-22.south west)(C\y-29.north east)] (C\y Data1) {} ;
    \path (O) node[cache block,fit=(C\y-30.south west)(C\y-37.north east)] (C\y Data0) {} ;
}

% Memory address tag
\foreach \x/\d in {1/$\cdots$,2/1,3/0,4/1,5/0}
{
    \path (M\x) node[] (LBM\x) {\d} ;
}

% % Memory address set
% \foreach \x/\d in {6/1,7/0}
% {
%     \path (M\x) node[red] (LBM\x) {\d} ;
% }

% % Memory address byte offset
% \foreach \x/\d in {8/0,9/0}
% {
%     \path (M\x) node[gray] (LBM\x) {\d} ;
% }

% % Cache set 2 v,u
% \foreach \x/\d in {0/1}
% {
%     \path (C2-\x) node[] (LBC2-\x) {\d} ;
% }
% \foreach \x/\d in {0/1}
% {
%     \path (D2-\x) node[] (LBD2-\x) {\d} ;
% }
% \foreach \x/\d in {15/0}
% {
%     \path (D2-\x) node[black!40!green] (LBD2-\x) {\d} ;
% }

% % Cache set 2 tag
% \foreach \x/\d in {2/$\cdots$,3/1,4/0,5/1,6/0}
% {
%     \path (C2-\x) node[] (LBC2-\x) {\d} ;
% }
% \foreach \x/\d in {2/$\cdots$,3/0,4/1,5/1,6/0}
% {
%     \path (D2-\x) node[] (LBD2-\x) {\d} ;
% }

% % Cache set 2 data
% \foreach \x/\d in {8/$\cdots$,9/1,10/0,11/0,12/0,13/1,14/1}
% {
%     \path (C2-\x) node[gray] (LBC2-\x) {\d} ;
% }
% \foreach \x/\d in {8/$\cdots$,9/0,10/1,11/0,12/1,13/0,14/0}
% {
%     \path (D2-\x) node[gray] (LBD2-\x) {\d} ;
% }

% % Memory address border line
% \draw[digital draw] (MTag.south west) rectangle (MByte.north east) ;

% % Cache border line
% \draw[digital draw] (C0V.south west) rectangle (D3U.north east) ;

% % Cache set marker
% \foreach \y/\b in {0/00,1/01,2/10,3/11}
% {
%     \path (D\y U.east) node[right,red] (LBSet\y) {\b} ;
% } 

% % Equal
% \path ($(MTag.south|-C0V)+(0,-1.2)$) node[equal,anchor=120] (Eq1) {\equalsymb} ;
% \path (Eq1.east) ++(2,0) node[equal] (Eq2) {\equalsymb} ;
% \path ($(C0Tag.south)!0.33!(Eq1.north)$) coordinate (yEq1) ;
% \path ($(C0Tag.south)!0.67!(Eq1.north)$) coordinate (yEq2) ;
% \path (yEq1) ++ (0,0.5) coordinate (yTag) ;

% % And
% \path (Eq1.south) ++(0,-1.0) node[digital,and port,anchor=in 2,f--r-] (And1) {} ; 
% \path (Eq2.south) ++(0,-1.0) node[digital,and port,anchor=in 2,f--r-] (And2) {} ; 
% \path ($(Eq1.south)!0.33!(And1.west)$) coordinate (yAnd1) ;
% \path ($(Eq1.south)!0.67!(And1.west)$) coordinate (yAnd2) ;

% % Or
% \path ($(And1.out)!0.5!(And2.out)$) ++ (0,-0.8) node[digital,or port,anchor=west,f--r-] (Or) {} ;
% \path ($(And1.out)!0.5!(Or.in 1)$) coordinate (yOr) ;
% \path (Or.out) ++ (0,-0.5) coordinate (yOut) ;

% % Mux
% \path ($(C0Data.south)!0.5!(D0Data.south)$) ++ (0,-3) node[digital,mux21,anchor=west,f--r-] (Mux) {} ; 
% \path ($(Mux.west)!0.6!(D0Data.south)$) coordinate (yMux) ;
% \foreach \mux in {Mux}
% {
%     \path (\mux.blpin 1) node[muxopt,below=0.1cm] {0};
%     \path (\mux.blpin 2) node[muxopt,below=0.1cm] {1};
% }

% % Memory.Set -> Cache
% \draw[line data,-latex] (MSet.south) node[below right,gray,font=\small] (LBs3) {$\log_{2}S=2$}  |- (C2V.west) node[above left,signal] (SISet) {Set[1:0]}  ;

% % Memory.Tag -> Equal
% \draw[line data] (MTag.south) -- (Eq1.120) ;
% \draw[line data] (MTag.south|-yTag) node[above right,signal] (SITag) {Tag[27:0]} node[circ] (SCTag) {}  -| (Eq2.120) ;

% % Cache.Tag -> Equal
% \draw[line data] (C0Tag.south) node[below right,signal] (SITagW1) {Tag1[27:0]} |- (Eq1.60|-yEq1) -- (Eq1.60) ; 
% \draw[line data] (D0Tag.south) node[below right,signal] (SITagW0) {Tag0[27:0]} |- (Eq2.60|-yEq2) -- (Eq2.60) ; 

% % Cache.V -> And
% \draw[line control] (C0V.south) -- (C0V.south|-yAnd1) node[above left,signal] (SIVW1) {V1} -- (And1.in 1|-yAnd1) -- (And1.in 1) ; 
% \draw[line control] (D0V.south) -- (D0V.south|-yAnd2) node[above left,signal] (SIVW0) {V0} -- (And2.in 1|-yAnd2) -- (And2.in 1) ; 

% % Equal -> And
% \draw[line control] (Eq1.south) -- (And1.in 2) ;
% \draw[line control] (Eq2.south) -- (And2.in 2) ;

% % And -> Or
% \draw[line control] (And1.out) -- (And1.out|-yOr) node[below] (SIHit1) {Hit1} -| (Or.in 2) ; 
% \draw[line control] (And2.out) -- (And2.out|-yOr) node[below] (SIHit2) {Hit0} -| (Or.in 1) ; 

% % Or -> Hit
% \draw[line control] (Or.out) -- (Or.out|-yOut) node[ocirc] (OCHit) {}  node[signal,below] (SIHit) {Hit} ;

% % Cache.Data -> Data
% \draw[line data] (C0Data.south) -- (C0Data.south|-yMux) node[left,signal] (SIDataW1) {Data1[31:0]} -| (Mux.blpin 2);  
% \draw[line data] (D0Data.south) -- (D0Data.south|-yMux) node[right,signal] (SIDataW0) {Data0[31:0]} -| (Mux.blpin 1);  
% \draw[line data] (Mux.brpin 1) -- (Mux.brpin 1|-yOut) node[below,signal] (SIData) {Data[31:0]} node[ocirc] (OCData) {} ;

% % Mux
% \draw[line control] (Mux.bbpin 1) -- ++ (-1.0,0) node[left] (SIHit1Mux) {Hit1} node[ocirc] (OCHit) {} ; 

% % Text of memory address
% \path (MTag.north) node[above,font=\rmfamily] (LBTag) {Tag} ; 
% \path (MSet.north) node[above,font=\rmfamily] (LBSet) {Set\vphantom{g}} ;
% \path (MByte.north east) node[right,font=\rmfamily] (LBOffset) {Byte Offset} ;  
% \path ($(M0.north)!0.5!(M9.north)$) node[above=0.5cm,font=\rmfamily\bfseries\large] (LBMemoryAddress) {Memory Address} ;

% % Text of cache
% \path (C3V.north) node[above,font=\rmfamily] (LBCacheV1) {V\vphantom{g}} ; 
% \path (C3Tag.north) node[above,font=\rmfamily] (LBCacheTag1) {Tag} ; 
% \path (C3Data.north) node[above,font=\rmfamily] (LBCacheData1) {Data\vphantom{g}} ; 
% \path (D3V.north) node[above,font=\rmfamily] (LBCacheV0) {V\vphantom{g}} ; 
% \path (D3Tag.north) node[above,font=\rmfamily] (LBCacheTag0) {Tag} ; 
% \path (D3Data.north) node[above,font=\rmfamily] (LBCacheData0) {Data\vphantom{g}} ; 
% \path (D3U.north) node[above,font=\rmfamily] (LBCacheU0) {U\vphantom{g}} ; 
% \path (LBSet3.north|-D3Data.north) node[above,font=\rmfamily] (LBCacheSet) {Set\vphantom{g}} ;  
% \path (C1-0.west) node[left,font=\rmfamily\bfseries\large] (LBCache) {Cache} ;

% % Text of way
% \path (C3Tag.north) ++ (0,1) coordinate (yWB) ++ (0,0.5) coordinate (yWA) ;
% \path ($(yWB)!0.5!(yWA)$) coordinate (yWC) ;  
% \draw[very thin] (C3V.west|-yWB) -- (C3V.west|-yWA) ; 
% \draw[very thin] (D3V.west|-yWB) -- (D3V.west|-yWA) ; 
% \draw[very thin] (D3U.west|-yWB) -- (D3U.west|-yWA) ; 
% \draw[very thin] (C3V.west|-yWC) -- node[above,font=\rmfamily] (LBWay1) {Way 1} (D3V.west|-yWC) ; 
% \draw[very thin] (D3V.west|-yWC) -- node[above,font=\rmfamily] (LBWay0) {Way 0} (D3U.west|-yWC) ; 

% % Border
% \draw[ultra thin] ($(MTag.west|-SIHit.south)+(-0.3,-0.2)$) rectangle ($(LBSet0.east|-LBMemoryAddress)+(0.2,0.4)$) ; 

\end{tikzpicture}
\end{document}
